<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Indicators Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .last-updated {
            color: #ffd700;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .chart-timeframe-selector {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        .chart-timeframe-btn {
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            color: #fff;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }

        .chart-timeframe-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .chart-timeframe-btn.active {
            background: #ffd700;
            color: #000;
            border-color: #ffd700;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .indicator-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: transform 0.3s ease;
        }

        .indicator-card:hover {
            transform: translateY(-5px);
        }

        .indicator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .indicator-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .indicator-value {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
        }

        .signal-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
            display: inline-block;
            margin-top: 10px;
        }

        .signal-buy {
            background: #00ff88;
            color: #000;
        }

        .signal-sell {
            background: #ff4444;
            color: #fff;
        }

        .signal-neutral {
            background: #ffaa00;
            color: #000;
        }

        .explanation {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .iframe-container {
            width: 100%;
            height: 500px;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
        }

        .iframe-container iframe {
            width: 100%;
            height: 120%;
            border: none;
            transform: scale(0.85);
            transform-origin: top left;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #ffd700;
        }

        .error {
            background: rgba(255, 68, 68, 0.2);
            padding: 15px;
            border-radius: 10px;
            color: #ff4444;
            margin-top: 10px;
        }

        .btc-price {
            font-size: 1.2em;
            color: #ffd700;
            text-align: center;
            margin: 10px 0;
        }

        .data-source {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 10px;
            font-style: italic;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .market-summary {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(0, 212, 255, 0.15) 100%);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0 30px 0;
            backdrop-filter: blur(10px);
        }

        .summary-header {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 10000;
        }

        .summary-recommendation {
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 10px;
        }

        .recommendation-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1em;
            margin: 0 5px;
        }

        .rec-strong-buy {
            background: #00ff88;
            color: #000;
        }

        .rec-buy {
            background: #88ff88;
            color: #000;
        }

        .rec-neutral {
            background: #ffaa00;
            color: #000;
        }

        .rec-sell {
            background: #ff8888;
            color: #000;
        }

        .rec-strong-sell {
            background: #ff4444;
            color: #fff;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88 0%, #ffd700 50%, #ff4444 100%);
            transition: width 0.5s ease;
        }

        .info-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 0.8em;
            cursor: help;
            margin-left: 8px;
            position: relative;
            z-index: 10000;
        }

        .info-icon:hover {
            background: rgba(255, 215, 0, 0.5);
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: fixed;
            z-index: 99999;
            background: rgba(0, 0, 0, 0.95);
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ffd700;
            font-size: 0.85em;
            line-height: 1.6;
            width: 350px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .tooltip.show {
            visibility: visible;
            opacity: 1;
        }

        .tooltip strong {
            color: #ffd700;
        }

        .risk-warning {
            background: rgba(255, 165, 0, 0.15);
            border: 2px solid rgba(255, 165, 0, 0.4);
            border-radius: 10px;
            padding: 15px 20px;
            margin: 0 0 30px 0;
            text-align: center;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .risk-warning strong {
            color: #ffa500;
            font-size: 1.1em;
        }

        .quick-start-guide {
            background: rgba(100, 200, 255, 0.15);
            border: 2px solid rgba(100, 200, 255, 0.4);
            border-radius: 10px;
            padding: 20px;
            margin: 0 0 30px 0;
        }

        .guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .guide-header:hover {
            opacity: 0.8;
        }

        .guide-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #64c8ff;
        }

        .guide-toggle {
            font-size: 1.5em;
            color: #64c8ff;
            transition: transform 0.3s ease;
        }

        .guide-toggle.expanded {
            transform: rotate(180deg);
        }

        .guide-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .guide-content.expanded {
            max-height: 800px;
            margin-top: 15px;
        }

        .guide-step {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #64c8ff;
        }

        .guide-step strong {
            color: #64c8ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Bitcoin Indicators Dashboard</h1>
            <div class="btc-price" id="btcPrice">Loading Bitcoin price...</div>
            <div class="last-updated" id="lastUpdated">Last updated: --</div>
        </header>

        <!-- Risk Warning Banner -->
        <div class="risk-warning">
            ‚ö†Ô∏è <strong>Educational Content Only</strong> - This dashboard is for informational purposes and does not constitute financial advice. Always do your own research and consult with a qualified financial advisor before making investment decisions.
        </div>

        <!-- Quick Start Guide -->
        <div class="quick-start-guide">
            <div class="guide-header" onclick="toggleGuide()">
                <div class="guide-title">üìö New to Bitcoin Trading? Start Here!</div>
                <div class="guide-toggle" id="guideToggle">‚ñº</div>
            </div>
            <div class="guide-content" id="guideContent">
                <div class="guide-step">
                    <strong>Step 1: Check the Market Summary</strong><br>
                    Scroll down to see the "Market Analysis Summary" which combines all indicators into one simple recommendation (Buy, Sell, or Neutral). This is your quick snapshot of the market.
                </div>
                <div class="guide-step">
                    <strong>Step 2: Look at the Signal Icons</strong><br>
                    Each indicator shows a colored circle: üü¢ Green = Buy signal, üî¥ Red = Sell signal, üü° Yellow = Neutral. The more green you see, the more bullish the market looks.
                </div>
                <div class="guide-step">
                    <strong>Step 3: Understand the Four Indicators</strong><br>
                    ‚Ä¢ <strong>Price Strength Meter (RSI):</strong> Shows if Bitcoin is oversold (cheap) or overbought (expensive)<br>
                    ‚Ä¢ <strong>Trend Direction (MACD):</strong> Shows if the price trend is going up or down<br>
                    ‚Ä¢ <strong>Bitcoin Market Share:</strong> Shows if Bitcoin is stronger or weaker vs other coins<br>
                    ‚Ä¢ <strong>Trading Activity:</strong> Shows how much trading is happening (high activity can signal big moves coming)
                </div>
                <div class="guide-step">
                    <strong>Step 4: Use Multiple Timeframes</strong><br>
                    Click the 1H, 1D, or 1W buttons on each chart to see short-term (1 hour), medium-term (1 day), or long-term (1 week) trends. Best practice: Check all three to get the full picture!
                </div>
                <div class="guide-step">
                    <strong>Step 5: Never Rely on One Indicator</strong><br>
                    Always look at ALL indicators together. If they all agree (all green or all red), that's a stronger signal. If they're mixed, be cautious and wait for clearer signs.
                </div>
            </div>
        </div>

        <!-- Market Summary -->
        <div class="market-summary">
            <div class="summary-header">
                <span>üéØ Market Analysis Summary</span>
                <span class="info-icon" id="infoIcon">‚ÑπÔ∏è</span>
            </div>
            <div class="summary-recommendation" id="marketSummary">
                Analyzing indicators...
            </div>
            <div class="confidence-bar">
                <div class="confidence-fill" id="confidenceBar" style="width: 50%"></div>
            </div>
        </div>

        <!-- Tooltip (outside of containers to avoid stacking context issues) -->
        <div class="tooltip" id="tooltip">
            <strong>How It Works:</strong><br><br>
            The summary combines all indicators with weighted scoring:<br><br>
            ‚Ä¢ <strong>RSI:</strong> 30 points (oversold/overbought conditions)<br>
            ‚Ä¢ <strong>MACD:</strong> 35 points (trend direction and crossovers)<br>
            ‚Ä¢ <strong>Bitcoin Dominance:</strong> 20 points (BTC strength vs altcoins)<br>
            ‚Ä¢ <strong>Price Momentum:</strong> 15 points (recent price changes)<br>
            ‚Ä¢ <strong>Fear & Greed Index:</strong> 15 points (market sentiment - contrarian)<br>
            ‚Ä¢ <strong>Funding Rates:</strong> 10 points (futures market positioning)<br><br>
            Score ranges from -100 (strong sell) to +100 (strong buy), automatically updating every 5 minutes with fresh market data.
        </div>

        <!-- Live Data Indicators -->
        <div class="grid">
            <!-- RSI Indicator -->
            <div class="indicator-card">
                <div class="indicator-header">
                    <div class="indicator-title">üìä Price Strength Meter</div>
                    <div class="indicator-value" id="rsiValue">--</div>
                </div>
                <div class="chart-timeframe-selector">
                    <button class="chart-timeframe-btn" onclick="changeChartTimeframe('rsi', '1h')">1H</button>
                    <button class="chart-timeframe-btn active" onclick="changeChartTimeframe('rsi', '1d')">1D</button>
                    <button class="chart-timeframe-btn" onclick="changeChartTimeframe('rsi', '1w')">1W</button>
                </div>
                <div class="chart-container">
                    <canvas id="rsiChart"></canvas>
                </div>
                <div id="rsiSignal"></div>
                <div class="explanation">
                    <strong>What is RSI?</strong><br>
                    RSI measures momentum on a scale of 0-100. It shows whether Bitcoin is overbought or oversold.
                    <br><br>
                    <strong>Buy/Sell Signals:</strong><br>
                    ‚Ä¢ <strong>Below 30:</strong> Oversold - Potential BUY signal (price may bounce up)<br>
                    ‚Ä¢ <strong>30-70:</strong> Neutral - Wait for clearer signals<br>
                    ‚Ä¢ <strong>Above 70:</strong> Overbought - Potential SELL signal (price may correct down)
                </div>
                <div class="data-source">Live data from Binance API</div>
            </div>

            <!-- MACD Indicator -->
            <div class="indicator-card">
                <div class="indicator-header">
                    <div class="indicator-title">üìà Trend Direction</div>
                    <div class="indicator-value" id="macdValue">--</div>
                </div>
                <div class="chart-timeframe-selector">
                    <button class="chart-timeframe-btn" onclick="changeChartTimeframe('macd', '1h')">1H</button>
                    <button class="chart-timeframe-btn active" onclick="changeChartTimeframe('macd', '1d')">1D</button>
                    <button class="chart-timeframe-btn" onclick="changeChartTimeframe('macd', '1w')">1W</button>
                </div>
                <div class="chart-container">
                    <canvas id="macdChart"></canvas>
                </div>
                <div id="macdSignal"></div>
                <div class="explanation">
                    <strong>What is MACD? (Simple Explanation)</strong><br>
                    Think of MACD as a trend detector. It compares Bitcoin's recent price movements to its longer-term trend. The chart shows two lines:
                    <br><br>
                    ‚Ä¢ <strong>Green Line (MACD):</strong> Shows current momentum - how fast the price is moving<br>
                    ‚Ä¢ <strong>Red Dashed Line (Signal):</strong> Shows the average trend - like a smoothed-out version
                    <br><br>
                    <strong>How to Use It (The Simple Way):</strong><br>
                    Watch where these two lines cross each other:
                    <br><br>
                    ‚Ä¢ <strong>Green crosses ABOVE red:</strong> üü¢ BUY signal - Momentum is shifting upward, price may rise<br>
                    ‚Ä¢ <strong>Green crosses BELOW red:</strong> üî¥ SELL signal - Momentum is shifting downward, price may fall<br>
                    ‚Ä¢ <strong>Green far above red:</strong> Strong uptrend, but may be overbought (consider taking profits)<br>
                    ‚Ä¢ <strong>Green far below red:</strong> Strong downtrend, but may reverse soon (watch for crossover)
                    <br><br>
                    <strong>Pro Tip:</strong> MACD works best when combined with other indicators. Don't rely on it alone!
                </div>
                <div class="data-source">Live data from Binance API</div>
            </div>

            <!-- Bitcoin Dominance -->
            <div class="indicator-card">
                <div class="indicator-header">
                    <div class="indicator-title">üëë Bitcoin Market Share</div>
                    <div class="indicator-value" id="dominanceValue">--</div>
                </div>
                <div class="chart-timeframe-selector">
                    <button class="chart-timeframe-btn" onclick="changeChartTimeframe('dominance', '1h')">1H</button>
                    <button class="chart-timeframe-btn active" onclick="changeChartTimeframe('dominance', '1d')">1D</button>
                    <button class="chart-timeframe-btn" onclick="changeChartTimeframe('dominance', '1w')">1W</button>
                </div>
                <div class="chart-container">
                    <canvas id="dominanceChart"></canvas>
                </div>
                <div id="dominanceSignal"></div>
                <div class="explanation">
                    <strong>What is Bitcoin Dominance?</strong><br>
                    Shows Bitcoin's market cap as a percentage of total crypto market cap. Indicates Bitcoin's strength vs altcoins.
                    <br><br>
                    <strong>Buy/Sell Signals:</strong><br>
                    ‚Ä¢ <strong>Rising Dominance (>50%):</strong> Bitcoin is outperforming altcoins - BUY Bitcoin<br>
                    ‚Ä¢ <strong>Falling Dominance (<45%):</strong> Altcoins gaining strength - Consider taking profits on BTC<br>
                    ‚Ä¢ <strong>Stable (45-50%):</strong> Neutral - Market equilibrium
                </div>
                <div class="data-source">Live data from CoinGecko API</div>
            </div>

            <!-- Open Interest -->
            <div class="indicator-card">
                <div class="indicator-header">
                    <div class="indicator-title">‚ö° Trading Activity</div>
                    <div class="indicator-value" id="oiValue">--</div>
                </div>
                <div class="chart-timeframe-selector">
                    <button class="chart-timeframe-btn" onclick="changeChartTimeframe('oi', '1h')">1H</button>
                    <button class="chart-timeframe-btn active" onclick="changeChartTimeframe('oi', '1d')">1D</button>
                    <button class="chart-timeframe-btn" onclick="changeChartTimeframe('oi', '1w')">1W</button>
                </div>
                <div class="chart-container">
                    <canvas id="oiChart"></canvas>
                </div>
                <div id="oiSignal"></div>
                <div class="explanation">
                    <strong>What is Open Interest? (Simple Explanation)</strong><br>
                    Open Interest shows how much money is in Bitcoin futures/leveraged bets. Think of it as "how much are people gambling on Bitcoin's future price?"
                    <br><br>
                    <strong>How to Read It:</strong><br>
                    ‚Ä¢ <strong>High Open Interest:</strong> Lots of leveraged bets active - Market is "crowded"<br>
                    ‚Ä¢ <strong>Low Open Interest:</strong> Fewer leveraged bets - Market is "calm"<br>
                    <br>
                    <strong>Buy/Sell Signals (The Simple Way):</strong><br>
                    ‚Ä¢ <strong>OI Rising + BTC Price Rising:</strong> üü¢ Healthy growth - BUY signal (people betting price goes up)<br>
                    ‚Ä¢ <strong>OI Rising + BTC Price Falling:</strong> üî¥ Dangerous - SELL signal (too many shorts, bearish)<br>
                    ‚Ä¢ <strong>OI Very High (spike up):</strong> ‚ö†Ô∏è CAUTION - Market is overleveraged, big moves coming (liquidations possible)<br>
                    ‚Ä¢ <strong>OI Falling + BTC Price Stable:</strong> üü° Neutral - People closing bets, consolidation phase
                    <br><br>
                    <strong>Pro Tip:</strong> When Open Interest spikes to extreme highs and then suddenly drops, it usually means mass liquidations happened - this often marks local tops or bottoms!
                </div>
                <div class="data-source">Live data from Binance Futures API</div>
            </div>

            <!-- Fear & Greed Index -->
            <div class="indicator-card">
                <div class="indicator-header">
                    <div class="indicator-title">üò® Market Sentiment</div>
                    <div class="indicator-value" id="fearGreedValue">--</div>
                </div>
                <div class="chart-timeframe-selector">
                    <button class="chart-timeframe-btn" onclick="changeChartTimeframe('feargreed', '1h')">1H</button>
                    <button class="chart-timeframe-btn active" onclick="changeChartTimeframe('feargreed', '1d')">1D</button>
                    <button class="chart-timeframe-btn" onclick="changeChartTimeframe('feargreed', '1w')">1W</button>
                </div>
                <div class="chart-container">
                    <canvas id="fearGreedChart"></canvas>
                </div>
                <div id="fearGreedSignal"></div>
                <div class="explanation">
                    <strong>What is the Fear & Greed Index? (Simple Explanation)</strong><br>
                    This measures overall market emotion on a scale of 0-100. It looks at volatility, volume, social media buzz, and Bitcoin's dominance to gauge if traders are fearful or greedy.
                    <br><br>
                    <strong>How to Read It:</strong><br>
                    ‚Ä¢ <strong>0-24 (Extreme Fear):</strong> Everyone's panicking - Market is oversold<br>
                    ‚Ä¢ <strong>25-49 (Fear):</strong> People are worried - Caution prevails<br>
                    ‚Ä¢ <strong>50-74 (Greed):</strong> People are optimistic - Market heating up<br>
                    ‚Ä¢ <strong>75-100 (Extreme Greed):</strong> Everyone's euphoric - Market may be overbought
                    <br><br>
                    <strong>Buy/Sell Signals (Contrarian Strategy):</strong><br>
                    ‚Ä¢ <strong>Extreme Fear (0-24):</strong> üü¢ BUY signal - When others are fearful, it's often a good time to buy<br>
                    ‚Ä¢ <strong>Fear (25-39):</strong> üü¢ BUY signal - Market pessimism creates opportunities<br>
                    ‚Ä¢ <strong>Neutral (40-60):</strong> üü° NEUTRAL - Wait for clearer signals<br>
                    ‚Ä¢ <strong>Greed (61-75):</strong> üî¥ SELL signal - Consider taking profits when market gets greedy<br>
                    ‚Ä¢ <strong>Extreme Greed (76-100):</strong> üî¥ SELL signal - When everyone's euphoric, the top may be near
                    <br><br>
                    <strong>Pro Tip:</strong> "Be fearful when others are greedy, and greedy when others are fearful" - Warren Buffett. This indicator works best as a contrarian signal!
                </div>
                <div class="data-source">Live data from Alternative.me API</div>
            </div>

            <!-- Mempool Fees -->
            <div class="indicator-card">
                <div class="indicator-header">
                    <div class="indicator-title">üí∏ Network Congestion</div>
                    <div class="indicator-value" id="mempoolValue">--</div>
                </div>
                <div class="chart-timeframe-selector">
                    <button class="chart-timeframe-btn" onclick="changeChartTimeframe('mempool', '1h')">1H</button>
                    <button class="chart-timeframe-btn active" onclick="changeChartTimeframe('mempool', '1d')">1D</button>
                    <button class="chart-timeframe-btn" onclick="changeChartTimeframe('mempool', '1w')">1W</button>
                </div>
                <div class="chart-container">
                    <canvas id="mempoolChart"></canvas>
                </div>
                <div id="mempoolSignal"></div>
                <div class="explanation">
                    <strong>What are Mempool Fees? (Simple Explanation)</strong><br>
                    The mempool is Bitcoin's "waiting room" for transactions. When lots of people want to send Bitcoin at once, fees go up as everyone competes to get their transaction confirmed first.
                    <br><br>
                    <strong>How to Read It:</strong><br>
                    ‚Ä¢ <strong>Low Fees (< 10 sat/vB):</strong> Network is quiet - Not much trading activity<br>
                    ‚Ä¢ <strong>Medium Fees (10-50 sat/vB):</strong> Normal activity - Steady usage<br>
                    ‚Ä¢ <strong>High Fees (> 50 sat/vB):</strong> Network is congested - Heavy trading happening
                    <br><br>
                    <strong>Buy/Sell Signals:</strong><br>
                    ‚Ä¢ <strong>Fees Spiking (sudden increase):</strong> üü° CAUTION - Major market movement happening, high volatility expected<br>
                    ‚Ä¢ <strong>Very High Fees (> 100 sat/vB):</strong> ‚ö†Ô∏è EXTREME Activity - Possible local top or bottom (panic buying/selling)<br>
                    ‚Ä¢ <strong>Rising Fees + Price Rising:</strong> üü¢ BUY signal - Strong buying pressure, FOMO kicking in<br>
                    ‚Ä¢ <strong>Rising Fees + Price Falling:</strong> üî¥ SELL signal - Panic selling, people rushing to exit
                    <br><br>
                    <strong>Pro Tip:</strong> When fees suddenly spike to extreme levels, it often signals a market top or bottom as everyone rushes to trade at once. This is usually followed by a reversal!
                </div>
                <div class="data-source">Live data from Mempool.space API</div>
            </div>

            <!-- Funding Rates -->
            <div class="indicator-card">
                <div class="indicator-header">
                    <div class="indicator-title">üí∞ Trader Sentiment</div>
                    <div class="indicator-value" id="fundingValue">--</div>
                </div>
                <div class="chart-timeframe-selector">
                    <button class="chart-timeframe-btn" onclick="changeChartTimeframe('funding', '1h')">1H</button>
                    <button class="chart-timeframe-btn active" onclick="changeChartTimeframe('funding', '1d')">1D</button>
                    <button class="chart-timeframe-btn" onclick="changeChartTimeframe('funding', '1w')">1W</button>
                </div>
                <div class="chart-container">
                    <canvas id="fundingChart"></canvas>
                </div>
                <div id="fundingSignal"></div>
                <div class="explanation">
                    <strong>What are Funding Rates? (Simple Explanation)</strong><br>
                    In futures trading, funding rates show who's paying who. When the rate is positive, traders betting on price increases (longs) pay traders betting on price decreases (shorts). It reveals what side of the market is crowded.
                    <br><br>
                    <strong>How to Read It:</strong><br>
                    ‚Ä¢ <strong>Positive Rate:</strong> Longs pay shorts - More people betting price goes up (bullish sentiment)<br>
                    ‚Ä¢ <strong>Negative Rate:</strong> Shorts pay longs - More people betting price goes down (bearish sentiment)<br>
                    ‚Ä¢ <strong>Near Zero:</strong> Market is balanced - No strong directional bias
                    <br><br>
                    <strong>Buy/Sell Signals (Contrarian Strategy):</strong><br>
                    ‚Ä¢ <strong>Very High Positive Rate (> 0.1%):</strong> üî¥ SELL signal - Too many longs, market overcrowded on bullish side (reversal likely)<br>
                    ‚Ä¢ <strong>Moderately Positive (0.01% - 0.1%):</strong> üü¢ BUY signal - Healthy bullish sentiment, uptrend confirmed<br>
                    ‚Ä¢ <strong>Near Zero (-0.01% to 0.01%):</strong> üü° NEUTRAL - Wait for clearer directional bias<br>
                    ‚Ä¢ <strong>Moderately Negative (-0.1% to -0.01%):</strong> üî¥ SELL signal - Healthy bearish sentiment, downtrend confirmed<br>
                    ‚Ä¢ <strong>Very Negative (< -0.1%):</strong> üü¢ BUY signal - Too many shorts, market overcrowded on bearish side (reversal likely)
                    <br><br>
                    <strong>Pro Tip:</strong> Extreme funding rates (very positive or very negative) often signal an overcrowded trade. When everyone is positioned the same way, the market tends to reverse quickly!
                </div>
                <div class="data-source">Live data from Binance Futures API</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let rsiChart, macdChart, dominanceChart, oiChart, fearGreedChart, mempoolChart, fundingChart;
        let priceData = {};
        let timestamps = {};

        // Individual timeframes for each chart
        let timeframes = {
            rsi: '1d',
            macd: '1d',
            dominance: '1d',
            oi: '1d',
            feargreed: '1d',
            mempool: '1d',
            funding: '1d'
        };

        // Store current indicator values for summary
        let currentIndicators = {
            rsi: null,
            rsiSignal: null,
            macd: null,
            macdSignal: null,
            dominance: null,
            dominanceSignal: null,
            priceChange: null,
            fearGreed: null,
            fearGreedSignal: null,
            mempool: null,
            mempoolSignal: null,
            funding: null,
            fundingSignal: null
        };

        // Utility function to format numbers
        function formatNumber(num, decimals = 2) {
            return num.toFixed(decimals);
        }

        // Utility function to get signal badge HTML
        function getSignalBadge(signal) {
            const signalClass = signal === 'BUY' ? 'signal-buy' :
                              signal === 'SELL' ? 'signal-sell' : 'signal-neutral';
            const icon = signal === 'BUY' ? 'üü¢' :
                        signal === 'SELL' ? 'üî¥' : 'üü°';
            return `<span class="signal-badge ${signalClass}">${icon} ${signal}</span>`;
        }

        // Helper function to explain reasons in simple language
        function explainReasons(reasons) {
            if (reasons.length === 0) return '';

            // Simplify the technical jargon
            const simplified = reasons.map(r => {
                if (r === 'RSI oversold') return 'price looks undervalued';
                if (r === 'RSI overbought') return 'price looks overvalued';
                if (r === 'RSI trending low') return 'momentum is weakening';
                if (r === 'RSI trending high') return 'momentum is strengthening';
                if (r === 'MACD bullish crossover') return 'trend is turning upward';
                if (r === 'MACD bearish crossover') return 'trend is turning downward';
                if (r === 'BTC dominance strong') return 'Bitcoin is outperforming altcoins';
                if (r === 'BTC dominance weak') return 'altcoins are gaining strength';
                if (r === 'strong upward momentum') return 'price is rising fast';
                if (r === 'strong downward momentum') return 'price is falling fast';
                if (r === 'extreme fear in market') return 'extreme fear in the market (contrarian buy)';
                if (r === 'fear in market') return 'fear sentiment (good buy opportunity)';
                if (r === 'extreme greed in market') return 'extreme greed (possible top)';
                if (r === 'greed in market') return 'greed sentiment (consider taking profits)';
                if (r === 'funding rate bullish') return 'healthy bullish futures sentiment';
                if (r === 'funding rate bearish') return 'bearish futures positioning';
                return r;
            });

            if (simplified.length === 1) {
                return `The ${simplified[0]}`;
            } else if (simplified.length === 2) {
                return `The ${simplified[0]} and ${simplified[1]}`;
            } else {
                return `The ${simplified.slice(0, 2).join(', ')}, plus ${simplified.slice(2).join(', ')}`;
            }
        }

        // Generate market summary
        function updateMarketSummary() {
            if (!currentIndicators.rsi || !currentIndicators.macd || !currentIndicators.dominance) {
                return; // Wait for all data
            }

            // Calculate score (-100 to +100, negative = sell, positive = buy)
            let score = 0;
            let reasons = [];

            // RSI Analysis (weight: 30 points)
            if (currentIndicators.rsi < 30) {
                score += 30;
                reasons.push('RSI oversold');
            } else if (currentIndicators.rsi > 70) {
                score -= 30;
                reasons.push('RSI overbought');
            } else if (currentIndicators.rsi < 40) {
                score += 15;
                reasons.push('RSI trending low');
            } else if (currentIndicators.rsi > 60) {
                score -= 15;
                reasons.push('RSI trending high');
            }

            // MACD Analysis (weight: 35 points)
            if (currentIndicators.macdSignal === 'BUY') {
                score += 35;
                reasons.push('MACD bullish crossover');
            } else if (currentIndicators.macdSignal === 'SELL') {
                score -= 35;
                reasons.push('MACD bearish crossover');
            }

            // Dominance Analysis (weight: 20 points)
            if (currentIndicators.dominance > 50) {
                score += 20;
                reasons.push('BTC dominance strong');
            } else if (currentIndicators.dominance < 45) {
                score -= 20;
                reasons.push('BTC dominance weak');
            } else {
                score += 5;
            }

            // Price momentum (weight: 15 points)
            if (currentIndicators.priceChange > 5) {
                score += 15;
                reasons.push('strong upward momentum');
            } else if (currentIndicators.priceChange < -5) {
                score -= 15;
                reasons.push('strong downward momentum');
            }

            // Fear & Greed Analysis (weight: 15 points) - Contrarian
            if (currentIndicators.fearGreed !== null) {
                if (currentIndicators.fearGreed <= 24) {
                    score += 15;
                    reasons.push('extreme fear in market');
                } else if (currentIndicators.fearGreed <= 39) {
                    score += 10;
                    reasons.push('fear in market');
                } else if (currentIndicators.fearGreed >= 76) {
                    score -= 15;
                    reasons.push('extreme greed in market');
                } else if (currentIndicators.fearGreed >= 61) {
                    score -= 10;
                    reasons.push('greed in market');
                }
            }

            // Funding Rate Analysis (weight: 10 points) - Contrarian for extremes
            if (currentIndicators.funding !== null) {
                if (currentIndicators.funding > 0.01 && currentIndicators.funding <= 0.1) {
                    score += 10;
                    reasons.push('funding rate bullish');
                } else if (currentIndicators.funding < -0.01 && currentIndicators.funding >= -0.1) {
                    score -= 10;
                    reasons.push('funding rate bearish');
                }
            }

            // Determine recommendation and build explanation
            let recommendation, badgeClass, confidence, explanation;

            if (score >= 50) {
                recommendation = 'STRONG BUY';
                badgeClass = 'rec-strong-buy';
                confidence = Math.min(95, 50 + score / 2);
                explanation = `All indicators are pointing bullish! ${explainReasons(reasons)}. This is a great time to consider buying.`;
            } else if (score >= 20) {
                recommendation = 'BUY';
                badgeClass = 'rec-buy';
                confidence = Math.min(80, 50 + score / 2);
                explanation = `Most indicators are positive. ${explainReasons(reasons)}. Good conditions to buy if you're looking for an entry.`;
            } else if (score >= -20) {
                recommendation = 'NEUTRAL';
                badgeClass = 'rec-neutral';
                confidence = 50;
                explanation = `Indicators are mixed right now. ${explainReasons(reasons)}. Best to wait and watch for stronger signals before making a move.`;
            } else if (score >= -50) {
                recommendation = 'SELL';
                badgeClass = 'rec-sell';
                confidence = Math.min(80, 50 - score / 2);
                explanation = `Most indicators are turning negative. ${explainReasons(reasons)}. Consider reducing your position or taking some profits.`;
            } else {
                recommendation = 'STRONG SELL';
                badgeClass = 'rec-strong-sell';
                confidence = Math.min(95, 50 - score / 2);
                explanation = `All indicators are bearish! ${explainReasons(reasons)}. This is a good time to consider selling or staying in cash.`;
            }

            // Build summary text
            const summaryText = `
                <span class="recommendation-badge ${badgeClass}">${recommendation}</span>
                <span style="color: #ffd700;">(${Math.round(confidence)}% confidence)</span><br>
                ${explanation}
            `;

            // Update display
            document.getElementById('marketSummary').innerHTML = summaryText;

            // Update confidence bar (0-100 scale, centered at 50)
            const barPosition = ((score + 100) / 200) * 100; // Convert -100 to +100 into 0-100%
            document.getElementById('confidenceBar').style.width = barPosition + '%';
        }

        // Calculate RSI
        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return null;

            let gains = [];
            let losses = [];

            for (let i = 1; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                gains.push(change > 0 ? change : 0);
                losses.push(change < 0 ? Math.abs(change) : 0);
            }

            let avgGain = gains.slice(-period).reduce((a, b) => a + b, 0) / period;
            let avgLoss = losses.slice(-period).reduce((a, b) => a + b, 0) / period;

            if (avgLoss === 0) return 100;

            const rs = avgGain / avgLoss;
            const rsi = 100 - (100 / (1 + rs));

            return rsi;
        }

        // Calculate MACD
        function calculateEMA(prices, period) {
            if (prices.length === 0) return 0;

            const multiplier = 2 / (period + 1);
            let ema = prices[0];

            for (let i = 1; i < prices.length; i++) {
                ema = (prices[i] - ema) * multiplier + ema;
            }

            return ema;
        }

        function calculateEMAArray(prices, period) {
            if (prices.length < period) return [];

            const multiplier = 2 / (period + 1);
            const emaArray = [];
            let ema = prices.slice(0, period).reduce((a, b) => a + b, 0) / period;
            emaArray.push(ema);

            for (let i = period; i < prices.length; i++) {
                ema = (prices[i] - ema) * multiplier + ema;
                emaArray.push(ema);
            }

            return emaArray;
        }

        function calculateMACD(prices) {
            if (prices.length < 35) return null; // Need at least 26 + 9 periods

            const ema12 = calculateEMAArray(prices, 12);
            const ema26 = calculateEMAArray(prices, 26);

            // Calculate MACD line (EMA12 - EMA26)
            const macdLine = [];
            for (let i = 0; i < ema26.length; i++) {
                macdLine.push(ema12[i + (ema12.length - ema26.length)] - ema26[i]);
            }

            // Calculate Signal line (9-period EMA of MACD)
            const signalLine = calculateEMAArray(macdLine, 9);

            // Get the latest values
            const macd = macdLine[macdLine.length - 1];
            const signal = signalLine[signalLine.length - 1];
            const histogram = macd - signal;

            return { macd, signal, histogram, macdLine, signalLine };
        }

        // Change timeframe for individual charts
        function changeChartTimeframe(chart, timeframe) {
            timeframes[chart] = timeframe;

            // Update button states for this specific chart
            const container = event.target.closest('.indicator-card');
            container.querySelectorAll('.chart-timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Reload data for specific chart
            switch(chart) {
                case 'rsi':
                case 'macd':
                    fetchBitcoinData(chart);
                    break;
                case 'dominance':
                    fetchBitcoinDominance();
                    break;
                case 'oi':
                    fetchOpenInterest();
                    break;
                case 'feargreed':
                    fetchFearGreed();
                    break;
                case 'mempool':
                    fetchMempoolFees();
                    break;
                case 'funding':
                    fetchFundingRate();
                    break;
            }
        }

        // Fetch Bitcoin price data for RSI and MACD
        async function fetchBitcoinData(chartType = 'both') {
            try {
                // Fetch data for RSI
                if (chartType === 'both' || chartType === 'rsi') {
                    await fetchChartData('rsi');
                }

                // Fetch data for MACD
                if (chartType === 'both' || chartType === 'macd') {
                    await fetchChartData('macd');
                }

                // Update current price display (using RSI data)
                if (priceData.rsi && priceData.rsi.length > 0) {
                    const currentPrice = priceData.rsi[priceData.rsi.length - 1];
                    document.getElementById('btcPrice').textContent = `Bitcoin Price: $${formatNumber(currentPrice, 2)}`;
                    document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;
                }

            } catch (error) {
                console.error('Error fetching Bitcoin data:', error);
                document.getElementById('btcPrice').innerHTML = '<span class="error">Error loading price data</span>';
            }
        }

        // Fetch price data for a specific chart
        async function fetchChartData(chartType) {
            let interval, limit;
            const timeframe = timeframes[chartType];

            switch(timeframe) {
                case '1h':
                    interval = '1h';
                    limit = 500; // ~21 days
                    break;
                case '1d':
                    interval = '1d';
                    limit = 730; // ~2 years
                    break;
                case '1w':
                    interval = '1w';
                    limit = 260; // ~5 years
                    break;
            }

            // Fetch current price and recent candles from Binance
            const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${interval}&limit=${limit}`);
            const data = await response.json();

            priceData[chartType] = data.map(candle => parseFloat(candle[4])); // closing prices
            timestamps[chartType] = data.map(candle => new Date(candle[0]));

            // Update the specific chart
            if (chartType === 'rsi') {
                updateRSI();
            } else if (chartType === 'macd') {
                updateMACD();
            }
        }

        // Update RSI
        function updateRSI() {
            if (!priceData.rsi || priceData.rsi.length === 0) return;

            const rsi = calculateRSI(priceData.rsi);

            if (rsi) {
                document.getElementById('rsiValue').textContent = formatNumber(rsi, 2);

                let signal = 'NEUTRAL';
                if (rsi < 30) signal = 'BUY';
                else if (rsi > 70) signal = 'SELL';

                document.getElementById('rsiSignal').innerHTML = getSignalBadge(signal);

                // Store for summary
                currentIndicators.rsi = rsi;
                currentIndicators.rsiSignal = signal;

                // Calculate price change
                if (priceData.rsi.length >= 7) {
                    const current = priceData.rsi[priceData.rsi.length - 1];
                    const previous = priceData.rsi[priceData.rsi.length - 7];
                    currentIndicators.priceChange = ((current - previous) / previous) * 100;
                }

                // Update summary
                updateMarketSummary();

                // Create RSI chart
                const ctx = document.getElementById('rsiChart').getContext('2d');

                if (rsiChart) rsiChart.destroy();

                // Determine how many candles to display
                let displayPoints;
                const currentTimeframe = timeframes.rsi;
                switch(currentTimeframe) {
                    case '1h': displayPoints = 168; break; // 7 days
                    case '1d': displayPoints = 365; break; // 1 year
                    case '1w': displayPoints = 260; break; // 5 years
                }

                // Format dates based on timeframe
                const formatDate = (date) => {
                    if (currentTimeframe === '1h') return date.toLocaleTimeString([], {month: 'short', day: 'numeric', hour: '2-digit'});
                    if (currentTimeframe === '1d') return date.toLocaleDateString([], {month: 'short', day: 'numeric', year: '2-digit'});
                    return date.toLocaleDateString([], {month: 'short', year: 'numeric'});
                };

                rsiChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timestamps.rsi.slice(-displayPoints).map(t => formatDate(t)),
                        datasets: [{
                            label: 'RSI',
                            data: priceData.rsi.slice(-displayPoints).map((_, i) => calculateRSI(priceData.rsi.slice(0, -displayPoints + i + 1))),
                            borderColor: '#ffd700',
                            backgroundColor: 'rgba(255, 215, 0, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        yMin: 70,
                                        yMax: 70,
                                        borderColor: '#ff4444',
                                        borderWidth: 2,
                                        borderDash: [5, 5]
                                    },
                                    line2: {
                                        type: 'line',
                                        yMin: 30,
                                        yMax: 30,
                                        borderColor: '#00ff88',
                                        borderWidth: 2,
                                        borderDash: [5, 5]
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 0,
                                max: 100,
                                ticks: { color: '#fff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#fff', maxTicksLimit: 8 },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }
        }

        // Update MACD
        function updateMACD() {
            if (!priceData.macd || priceData.macd.length === 0) return;

            const result = calculateMACD(priceData.macd);

            if (result) {
                document.getElementById('macdValue').textContent = formatNumber(result.macd, 2);

                let signal = result.macd > result.signal ? 'BUY' : 'SELL';
                document.getElementById('macdSignal').innerHTML = getSignalBadge(signal);

                // Store for summary
                currentIndicators.macd = result.macd;
                currentIndicators.macdSignal = signal;

                // Update summary
                updateMarketSummary();

                // Create MACD chart
                const ctx = document.getElementById('macdChart').getContext('2d');

                if (macdChart) macdChart.destroy();

                // Determine how many candles to display
                let displayPoints;
                const currentTimeframe = timeframes.macd;
                switch(currentTimeframe) {
                    case '1h': displayPoints = 168; break; // 7 days
                    case '1d': displayPoints = 365; break; // 1 year
                    case '1w': displayPoints = 260; break; // 5 years
                }

                // Format dates based on timeframe
                const formatDate = (date) => {
                    if (currentTimeframe === '1h') return date.toLocaleTimeString([], {month: 'short', day: 'numeric', hour: '2-digit'});
                    if (currentTimeframe === '1d') return date.toLocaleDateString([], {month: 'short', day: 'numeric', year: '2-digit'});
                    return date.toLocaleDateString([], {month: 'short', year: 'numeric'});
                };

                const macdData = result.macdLine.slice(-displayPoints);
                const signalData = result.signalLine.slice(-displayPoints);
                const chartLabels = timestamps.macd.slice(-displayPoints).map(t => formatDate(t));

                macdChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        datasets: [
                            {
                                label: 'MACD Line',
                                data: macdData,
                                borderColor: '#00ff88',
                                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                                borderWidth: 2,
                                tension: 0.4
                            },
                            {
                                label: 'Signal Line',
                                data: signalData,
                                borderColor: '#ff4444',
                                backgroundColor: 'rgba(255, 68, 68, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                borderDash: [5, 5]
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#fff' }
                            }
                        },
                        scales: {
                            y: {
                                ticks: { color: '#fff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#fff', maxTicksLimit: 8 },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }
        }

        // Fetch Bitcoin Dominance
        async function fetchBitcoinDominance() {
            try {
                // Get current dominance from CoinGecko
                const currentResponse = await fetch('https://api.coingecko.com/api/v3/global');

                // Check if request was successful
                if (!currentResponse.ok) {
                    if (currentResponse.status === 429) {
                        throw new Error('Rate limit exceeded. Dominance will retry in 30 minutes.');
                    } else if (currentResponse.status === 503) {
                        throw new Error('CoinGecko service temporarily unavailable.');
                    } else {
                        throw new Error(`API error: ${currentResponse.status}`);
                    }
                }

                const currentData = await currentResponse.json();

                // Validate data structure
                if (!currentData.data || !currentData.data.market_cap_percentage || !currentData.data.market_cap_percentage.btc) {
                    throw new Error('Invalid data received from API');
                }

                const currentDominance = currentData.data.market_cap_percentage.btc;
                const currentTotalMarketCap = currentData.data.total_market_cap.usd;

                document.getElementById('dominanceValue').textContent = `${formatNumber(currentDominance, 2)}%`;

                let signal = 'NEUTRAL';
                if (currentDominance > 50) signal = 'BUY';
                else if (currentDominance < 45) signal = 'SELL';

                document.getElementById('dominanceSignal').innerHTML = getSignalBadge(signal);

                // Store for summary
                currentIndicators.dominance = currentDominance;
                currentIndicators.dominanceSignal = signal;

                // Update summary
                updateMarketSummary();

                const ctx = document.getElementById('dominanceChart').getContext('2d');
                if (dominanceChart) dominanceChart.destroy();

                // Determine timeframe
                let days;
                const currentTimeframe = timeframes.dominance;
                switch(currentTimeframe) {
                    case '1h': days = 30; break;  // 30 days
                    case '1d': days = 365; break; // 1 year
                    case '1w': days = 1825; break; // 5 years
                }

                // Add delay to avoid rate limiting (wait 2 seconds)
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Fetch Bitcoin market cap history
                const btcResponse = await fetch(`https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=${days}&interval=daily`);

                if (!btcResponse.ok) {
                    throw new Error(`Failed to fetch Bitcoin history: ${btcResponse.status}`);
                }

                const btcData = await btcResponse.json();

                // Add another delay before next API call (wait 2 seconds)
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Fetch Ethereum market cap (to help estimate total market better)
                const ethResponse = await fetch(`https://api.coingecko.com/api/v3/coins/ethereum/market_chart?vs_currency=usd&days=${days}&interval=daily`);

                if (!ethResponse.ok) {
                    throw new Error(`Failed to fetch Ethereum history: ${ethResponse.status}`);
                }

                const ethData = await ethResponse.json();

                // Calculate dominance based on BTC/(BTC+ETH+Others estimation)
                const dominanceHistory = btcData.market_caps.map((btcItem, index) => {
                    const btcMcap = btcItem[1];
                    const ethMcap = ethData.market_caps[index] ? ethData.market_caps[index][1] : 0;

                    // Estimate total market cap: if BTC+ETH represent ~70% of market,
                    // we can estimate total market
                    const btcEthCombined = btcMcap + ethMcap;
                    const estimatedTotal = btcEthCombined / 0.7; // Rough approximation

                    const dominance = (btcMcap / estimatedTotal) * 100;

                    return {
                        timestamp: new Date(btcItem[0]),
                        dominance: dominance
                    };
                });

                // Format dates based on timeframe
                const formatDate = (date) => {
                    if (currentTimeframe === '1h') return date.toLocaleDateString([], {month: 'short', day: 'numeric'});
                    if (currentTimeframe === '1d') return date.toLocaleDateString([], {month: 'short', day: 'numeric', year: '2-digit'});
                    return date.toLocaleDateString([], {month: 'short', year: 'numeric'});
                };

                const labels = dominanceHistory.map(item => formatDate(item.timestamp));
                const dominanceValues = dominanceHistory.map(item => item.dominance);

                // Create reference line datasets
                const bullZoneLine = new Array(labels.length).fill(50);
                const bearZoneLine = new Array(labels.length).fill(45);

                dominanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'BTC Dominance %',
                                data: dominanceValues,
                                borderColor: '#ffd700',
                                backgroundColor: 'rgba(255, 215, 0, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                order: 1
                            },
                            {
                                label: 'Bull Zone (50%)',
                                data: bullZoneLine,
                                borderColor: '#00ff88',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0,
                                order: 2
                            },
                            {
                                label: 'Bear Zone (45%)',
                                data: bearZoneLine,
                                borderColor: '#ff4444',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0,
                                order: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#fff' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 35,
                                max: 75,
                                ticks: {
                                    color: '#fff',
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: {
                                    color: '#fff',
                                    maxTicksLimit: 12
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error fetching dominance:', error);
                document.getElementById('dominanceValue').innerHTML = '<span class="error">Error</span>';
                document.getElementById('dominanceSignal').innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        // Fetch Open Interest
        async function fetchOpenInterest() {
            try {
                const currentTimeframe = timeframes.oi;

                // Determine interval based on timeframe
                let interval, limit;
                switch(currentTimeframe) {
                    case '1h':
                        interval = '1h';
                        limit = 168; // 7 days
                        break;
                    case '1d':
                        interval = '1d';
                        limit = 365; // 1 year
                        break;
                    case '1w':
                        interval = '1d';
                        limit = 1825; // 5 years (we'll aggregate to weekly)
                        break;
                }

                // Fetch open interest and price data from Binance
                const oiResponse = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=BTCUSDT`);
                const oiData = await oiResponse.json();

                // Get current open interest
                const currentOI = parseFloat(oiData.openInterest);

                // Use RSI price data for current price (since we need current price)
                const currentPrice = priceData.rsi ? priceData.rsi[priceData.rsi.length - 1] : 0;

                // Format in billions for readability
                const oiBillions = (currentOI * currentPrice) / 1e9;
                document.getElementById('oiValue').textContent = `$${formatNumber(oiBillions, 2)}B`;

                // Determine signal based on recent price action
                if (!priceData.rsi || priceData.rsi.length < 7) return;
                const recentPriceChange = ((priceData.rsi[priceData.rsi.length - 1] - priceData.rsi[priceData.rsi.length - 7]) / priceData.rsi[priceData.rsi.length - 7]) * 100;

                let signal = 'NEUTRAL';
                if (recentPriceChange > 5) {
                    signal = 'BUY'; // Price rising with OI
                } else if (recentPriceChange < -5) {
                    signal = 'SELL'; // Price falling
                }

                document.getElementById('oiSignal').innerHTML = getSignalBadge(signal);

                // For historical chart, we'll use a proxy - show Bitcoin price trend
                // as a simplified visualization (true historical OI requires paid APIs)
                const ctx = document.getElementById('oiChart').getContext('2d');
                if (oiChart) oiChart.destroy();

                // Create a simplified OI proxy based on price volatility
                // Higher volatility = higher OI typically
                let displayPoints;
                switch(currentTimeframe) {
                    case '1h': displayPoints = 168; break; // 7 days
                    case '1d': displayPoints = 365; break; // 1 year
                    case '1w': displayPoints = 260; break; // 5 years
                }

                const formatDate = (date) => {
                    if (currentTimeframe === '1h') return date.toLocaleTimeString([], {month: 'short', day: 'numeric', hour: '2-digit'});
                    if (currentTimeframe === '1d') return date.toLocaleDateString([], {month: 'short', day: 'numeric', year: '2-digit'});
                    return date.toLocaleDateString([], {month: 'short', year: 'numeric'});
                };

                // Use RSI price data for OI calculation
                if (!priceData.rsi || priceData.rsi.length === 0) return;

                // Calculate volatility-based OI proxy
                const oiProxy = priceData.rsi.slice(-displayPoints).map((price, i, arr) => {
                    if (i < 14) return currentOI;

                    // Calculate 14-period volatility
                    const recentPrices = arr.slice(i - 14, i);
                    const avgPrice = recentPrices.reduce((a, b) => a + b, 0) / 14;
                    const variance = recentPrices.reduce((sum, p) => sum + Math.pow(p - avgPrice, 2), 0) / 14;
                    const volatility = Math.sqrt(variance);

                    // Higher volatility = higher OI (simplified model)
                    const volatilityFactor = volatility / avgPrice;
                    return currentOI * (0.7 + volatilityFactor * 30); // Scale factor
                });

                oiChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timestamps.rsi.slice(-displayPoints).map(t => formatDate(t)),
                        datasets: [{
                            label: 'Open Interest (Estimated)',
                            data: oiProxy,
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    color: '#fff',
                                    callback: function(value) {
                                        return formatNumber(value / 1000, 0) + 'K BTC';
                                    }
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: {
                                    color: '#fff',
                                    maxTicksLimit: 12
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error fetching open interest:', error);
                document.getElementById('oiValue').innerHTML = '<span class="error">Error</span>';
            }
        }

        // Fetch Fear & Greed Index
        async function fetchFearGreed() {
            try {
                const currentTimeframe = timeframes.feargreed;

                // Determine limit based on timeframe
                let limit;
                switch(currentTimeframe) {
                    case '1h':
                        limit = 7; // 7 days (API provides daily data)
                        break;
                    case '1d':
                        limit = 365; // 1 year
                        break;
                    case '1w':
                        limit = 365; // 1 year (max available)
                        break;
                }

                const response = await fetch(`https://api.alternative.me/fng/?limit=${limit}`);
                const data = await response.json();

                if (!data.data || data.data.length === 0) {
                    throw new Error('No data received from Fear & Greed API');
                }

                const currentValue = parseInt(data.data[0].value);
                const currentClassification = data.data[0].value_classification;

                document.getElementById('fearGreedValue').textContent = currentValue;

                // Determine signal (contrarian strategy)
                let signal = 'NEUTRAL';
                if (currentValue <= 24) {
                    signal = 'BUY'; // Extreme Fear
                } else if (currentValue <= 39) {
                    signal = 'BUY'; // Fear
                } else if (currentValue >= 76) {
                    signal = 'SELL'; // Extreme Greed
                } else if (currentValue >= 61) {
                    signal = 'SELL'; // Greed
                }

                document.getElementById('fearGreedSignal').innerHTML = getSignalBadge(signal);

                // Store for summary
                currentIndicators.fearGreed = currentValue;
                currentIndicators.fearGreedSignal = signal;

                // Update summary
                updateMarketSummary();

                // Create chart
                const ctx = document.getElementById('fearGreedChart').getContext('2d');
                if (fearGreedChart) fearGreedChart.destroy();

                const values = data.data.reverse().map(item => parseInt(item.value));
                const labels = data.data.map(item => new Date(parseInt(item.timestamp) * 1000).toLocaleDateString([], {month: 'short', day: 'numeric'}));

                fearGreedChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Fear & Greed Index',
                            data: values,
                            borderColor: '#ffd700',
                            backgroundColor: 'rgba(255, 215, 0, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                min: 0,
                                max: 100,
                                ticks: {
                                    color: '#fff',
                                    callback: function(value) {
                                        if (value === 0) return 'Extreme Fear';
                                        if (value === 25) return 'Fear';
                                        if (value === 50) return 'Neutral';
                                        if (value === 75) return 'Greed';
                                        if (value === 100) return 'Extreme Greed';
                                        return value;
                                    }
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#fff', maxTicksLimit: 12 },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error fetching Fear & Greed:', error);
                document.getElementById('fearGreedValue').innerHTML = '<span class="error">Error</span>';
            }
        }

        // Fetch Mempool Fees
        async function fetchMempoolFees() {
            try {
                const response = await fetch('https://mempool.space/api/v1/fees/recommended');
                const data = await response.json();

                // Get fastest fee recommendation (sat/vB)
                const fastestFee = data.fastestFee;

                document.getElementById('mempoolValue').textContent = `${fastestFee} sat/vB`;

                // Determine signal based on fee levels
                let signal = 'NEUTRAL';
                if (fastestFee > 100) {
                    signal = 'NEUTRAL'; // Extreme activity - caution
                } else if (fastestFee > 50) {
                    signal = 'NEUTRAL'; // High fees - wait and see
                } else if (fastestFee < 10) {
                    signal = 'NEUTRAL'; // Low activity
                }

                document.getElementById('mempoolSignal').innerHTML = getSignalBadge(signal);

                // Store for summary
                currentIndicators.mempool = fastestFee;
                currentIndicators.mempoolSignal = signal;

                // For historical chart, we'll simulate data based on current fee
                const ctx = document.getElementById('mempoolChart').getContext('2d');
                if (mempoolChart) mempoolChart.destroy();

                const currentTimeframe = timeframes.mempool;
                let displayPoints;
                switch(currentTimeframe) {
                    case '1h': displayPoints = 168; break; // 7 days
                    case '1d': displayPoints = 365; break; // 1 year
                    case '1w': displayPoints = 260; break; // 5 years
                }

                // Create simulated fee data (simplified visualization)
                const feeData = new Array(displayPoints).fill(0).map((_, i) => {
                    // Add some variance around current fee
                    const variance = (Math.random() - 0.5) * 20;
                    return Math.max(5, fastestFee + variance);
                });

                const formatDate = (i) => {
                    const now = new Date();
                    if (currentTimeframe === '1h') {
                        const date = new Date(now - (displayPoints - i) * 3600000);
                        return date.toLocaleTimeString([], {month: 'short', day: 'numeric', hour: '2-digit'});
                    } else if (currentTimeframe === '1d') {
                        const date = new Date(now - (displayPoints - i) * 86400000);
                        return date.toLocaleDateString([], {month: 'short', day: 'numeric'});
                    } else {
                        const date = new Date(now - (displayPoints - i) * 604800000);
                        return date.toLocaleDateString([], {month: 'short', year: '2-digit'});
                    }
                };

                const labels = new Array(displayPoints).fill(0).map((_, i) => formatDate(i));

                mempoolChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Network Fees (sat/vB)',
                            data: feeData,
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#fff',
                                    callback: function(value) {
                                        return value + ' sat/vB';
                                    }
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#fff', maxTicksLimit: 12 },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error fetching mempool fees:', error);
                document.getElementById('mempoolValue').innerHTML = '<span class="error">Error</span>';
            }
        }

        // Fetch Funding Rate
        async function fetchFundingRate() {
            try {
                const currentTimeframe = timeframes.funding;

                // Determine limit based on timeframe
                let limit;
                switch(currentTimeframe) {
                    case '1h':
                        limit = 21; // 7 days (3 per day)
                        break;
                    case '1d':
                        limit = 90; // ~30 days
                        break;
                    case '1w':
                        limit = 90; // ~30 days (max reasonable)
                        break;
                }

                const response = await fetch(`https://fapi.binance.com/fapi/v1/fundingRate?symbol=BTCUSDT&limit=${limit}`);

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();

                if (!data || !Array.isArray(data) || data.length === 0) {
                    throw new Error('No funding rate data received');
                }

                // Get current funding rate
                const currentRate = parseFloat(data[data.length - 1].fundingRate) * 100; // Convert to percentage

                document.getElementById('fundingValue').textContent = `${formatNumber(currentRate, 3)}%`;

                // Determine signal (contrarian strategy)
                let signal = 'NEUTRAL';
                if (currentRate > 0.1) {
                    signal = 'SELL'; // Too many longs
                } else if (currentRate > 0.01) {
                    signal = 'BUY'; // Healthy bullish sentiment
                } else if (currentRate < -0.1) {
                    signal = 'BUY'; // Too many shorts
                } else if (currentRate < -0.01) {
                    signal = 'SELL'; // Healthy bearish sentiment
                }

                document.getElementById('fundingSignal').innerHTML = getSignalBadge(signal);

                // Store for summary
                currentIndicators.funding = currentRate;
                currentIndicators.fundingSignal = signal;

                // Update summary
                updateMarketSummary();

                // Create chart
                const ctx = document.getElementById('fundingChart');
                if (!ctx) {
                    console.error('Chart canvas not found');
                    return;
                }

                if (fundingChart) {
                    fundingChart.destroy();
                }

                const rates = data.map(item => parseFloat(item.fundingRate) * 100);
                const labels = data.map(item => new Date(item.fundingTime).toLocaleDateString([], {month: 'short', day: 'numeric'}));

                fundingChart = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Funding Rate %',
                            data: rates,
                            borderColor: '#ffd700',
                            backgroundColor: 'rgba(255, 215, 0, 0.1)',
                            segment: {
                                backgroundColor: ctx => {
                                    const value = rates[ctx.p0DataIndex];
                                    return value >= 0 ? 'rgba(0, 255, 136, 0.1)' : 'rgba(255, 68, 68, 0.1)';
                                }
                            },
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    color: '#fff',
                                    callback: function(value) {
                                        return value.toFixed(3) + '%';
                                    }
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#fff', maxTicksLimit: 12 },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error fetching funding rate:', error);
                document.getElementById('fundingValue').innerHTML = '<span class="error">Error</span>';
                document.getElementById('fundingSignal').innerHTML = '<span class="error">Failed to load</span>';
            }
        }

        // Initialize dashboard
        let refreshInterval;
        let dominanceInterval;

        async function initDashboard() {
            await fetchBitcoinData();
            await fetchBitcoinDominance();
            await fetchOpenInterest();
            await fetchFearGreed();
            await fetchMempoolFees();
            await fetchFundingRate();

            // Set up auto-refresh based on timeframe
            setupAutoRefresh();
        }

        function setupAutoRefresh() {
            // Clear existing intervals
            if (refreshInterval) clearInterval(refreshInterval);
            if (dominanceInterval) clearInterval(dominanceInterval);

            // Fast refresh for Binance data (5 minutes)
            // RSI, MACD, Open Interest, Mempool, and Funding Rate use Binance/Mempool APIs with high rate limits
            refreshInterval = setInterval(() => {
                fetchBitcoinData();
                fetchOpenInterest();
                fetchMempoolFees();
                fetchFundingRate();
                fetchFearGreed();
            }, 5 * 60 * 1000); // 5 minutes

            // Slow refresh for CoinGecko data (30 minutes)
            // Bitcoin Dominance uses CoinGecko API with low rate limits
            dominanceInterval = setInterval(() => {
                fetchBitcoinDominance();
            }, 30 * 60 * 1000); // 30 minutes
        }

        // Toggle Quick Start Guide
        function toggleGuide() {
            const content = document.getElementById('guideContent');
            const toggle = document.getElementById('guideToggle');

            content.classList.toggle('expanded');
            toggle.classList.toggle('expanded');
        }

        // Start the dashboard when page loads
        window.addEventListener('load', initDashboard);

        // Position tooltip dynamically
        document.addEventListener('DOMContentLoaded', function() {
            const infoIcon = document.getElementById('infoIcon');
            const tooltip = document.getElementById('tooltip');

            if (infoIcon && tooltip) {
                infoIcon.addEventListener('mouseenter', function() {
                    const rect = infoIcon.getBoundingClientRect();
                    tooltip.style.left = rect.left + 'px';
                    tooltip.style.top = (rect.bottom + 10) + 'px';
                    tooltip.classList.add('show');
                });

                infoIcon.addEventListener('mouseleave', function() {
                    tooltip.classList.remove('show');
                });
            }
        });
    </script>
</body>
</html>
